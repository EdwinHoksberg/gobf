package main

import (
	"bytes"
	"testing"
)

func TestJit_Compile(t *testing.T) {
	var instructions = []Instruction{
		{name: Increment},
		{name: JumpIfZero},
		{name: Increment},
		{name: Decrement},
		{name: Increment},
		{name: JumpUnlessZero},
		{name: Read},
		{name: Write},
	}

	jit := Jit{}
	err := jit.Compile(instructions)

	if err != nil {
		t.Errorf("expected no error, got %s", err)
	}

	if !bytes.Equal(jit.code, []byte{
		0x09, 0x00, 0x80, 0xD2, 0x0A, 0x00, 0x80, 0xD2, 0xB, 0x00, 0x80, 0xD2, 0xEF, 0x03, 0x00, 0xAA, 0xEE, 0x03, 0x01, 0xAA,
		0xEB, 0x69, 0x69, 0x38, 0x6B, 0x05, 0x00, 0x91, 0xEB, 0x69, 0x29, 0x38, 0xEB, 0x69, 0x69, 0x38, 0xCB, 0xFF, 0xFF, 0x34,
		0xEB, 0x69, 0x69, 0x38, 0x6B, 0x05, 0x00, 0x91, 0xEB, 0x69, 0x29, 0x38, 0xEB, 0x69, 0x69, 0x38, 0x6B, 0x05, 0x00, 0xD1,
		0xEB, 0x69, 0x29, 0x38, 0xEB, 0x69, 0x69, 0x38, 0x6B, 0x05, 0x00, 0x91, 0xEB, 0x69, 0x29, 0x38, 0xEB, 0x69, 0x69, 0x38,
		0x6B, 0xFE, 0xFF, 0x35, 0x00, 0x00, 0x80, 0xD2, 0xE1, 0x03, 0x0F, 0xAA, 0x21, 0x00, 0x09, 0x8B, 0x22, 0x00, 0x80, 0xD2,
		0x70, 0x00, 0x80, 0xD2, 0x01, 0x10, 0x00, 0xD4, 0x20, 0x00, 0x80, 0xD2, 0xE1, 0x03, 0x0F, 0xAA, 0x21, 0x00, 0x09, 0x8B,
		0x22, 0x00, 0x80, 0xD2, 0x90, 0x00, 0x80, 0xD2, 0x01, 0x10, 0x00, 0xD4, 0xE0, 0x03, 0x0F, 0xAA, 0xC0, 0x03, 0x5F, 0xD6,
	}) {
		t.Errorf("jit code does not match expected code")
	}
}
