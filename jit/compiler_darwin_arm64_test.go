package jit

import (
	"github.com/stretchr/testify/assert"
	"gobf/instructions"
	"testing"
)

func TestJit_Compile(t *testing.T) {
	var testInstructions = []instructions.Instruction{
		{Name: instructions.MoveRight},
		{Name: instructions.MoveLeft},
		{Name: instructions.Increment},
		{Name: instructions.JumpIfZero},
		{Name: instructions.Increment},
		{Name: instructions.Decrement},
		{Name: instructions.Increment},
		{Name: instructions.JumpUnlessZero},
		{Name: instructions.Read},
		{Name: instructions.Write},
		{Name: instructions.Clear},
	}

	jit := NewJit(1000)
	err := jit.Compile(testInstructions)

	assert.NoError(t, err)

	assert.Equal(t, []byte{
		0x9, 0x0, 0x80, 0xd2, 0xa, 0x0, 0x80, 0xd2, 0xb, 0x0, 0x80, 0xd2, 0xef, 0x3, 0x0, 0xaa, 0x29, 0x1, 0x0,
		0x11, 0x29, 0x1, 0x0, 0x51, 0xeb, 0x69, 0x69, 0x38, 0x6b, 0x1, 0x0, 0x11, 0xeb, 0x69, 0x29, 0x38, 0xeb,
		0x69, 0x69, 0x38, 0x8b, 0xff, 0xff, 0x34, 0xeb, 0x69, 0x69, 0x38, 0x6b, 0x1, 0x0, 0x11, 0xeb, 0x69, 0x29,
		0x38, 0xeb, 0x69, 0x69, 0x38, 0x6b, 0x1, 0x0, 0x51, 0xeb, 0x69, 0x29, 0x38, 0xeb, 0x69, 0x69, 0x38, 0x6b,
		0x1, 0x0, 0x11, 0xeb, 0x69, 0x29, 0x38, 0xeb, 0x69, 0x69, 0x38, 0x2b, 0xfe, 0xff, 0x35, 0x0, 0x0, 0x80,
		0xd2, 0xe1, 0x3, 0xf, 0xaa, 0x21, 0x0, 0x9, 0x8b, 0x22, 0x0, 0x80, 0xd2, 0x70, 0x0, 0x80, 0xd2, 0x1, 0x10,
		0x0, 0xd4, 0x20, 0x0, 0x80, 0xd2, 0xe1, 0x3, 0xf, 0xaa, 0x21, 0x0, 0x9, 0x8b, 0x22, 0x0, 0x80, 0xd2, 0x90,
		0x0, 0x80, 0xd2, 0x1, 0x10, 0x0, 0xd4, 0xb, 0x0, 0x80, 0x52, 0xeb, 0x69, 0x29, 0x38, 0xe0, 0x3, 0xf, 0xaa,
		0xc0, 0x3, 0x5f, 0xd6,
	}, jit.code)
}
